<!DOCTYPE html>
<html lang="en">
<head>
    <title>Product</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/png" href="images/icons/favicon.png" />
    <link rel="stylesheet" type="text/css" href="vendor/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="fonts/font-awesome-4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="fonts/iconic/css/material-design-iconic-font.min.css">
    <link rel="stylesheet" type="text/css" href="fonts/linearicons-v1.0.0/icon-font.min.css">
    <link rel="stylesheet" type="text/css" href="vendor/animate/animate.css">
    <link rel="stylesheet" type="text/css" href="css/util.css">
    <link rel="stylesheet" type="text/css" href="css/main.css">
    <style> body { overflow: auto; } </style>
</head>
<body class="animsition">
<header class="header-v4">
    <div class="container-menu-desktop">
        <div class="wrap-menu-desktop how-shadow1">
            <nav class="limiter-menu-desktop container">

                <a class="logo" href="#">
                    <img alt="IMG-LOGO" src="images/icons/logo-01.png">
                </a>
                <div class="menu-desktop">
                    <ul class="main-menu">
                        <li>
                            <a href="index.html">Home</a>
                        </li>
                        <li>
                            <a href="product.html">Shop</a>
                        </li>
                        <li>
                            <a href="shoping-cart.html">Features</a>
                        </li>
                        <li>
                            <a href="blog.html">Blog</a>
                        </li>
                        <li>
                            <a href="about.html">About</a>
                        </li>
                        <li>
                            <a href="contact.html">Contact</a>
                        </li>
                    </ul>
                </div>
                <div class="wrap-icon-header flex-w flex-r-m">
                    <div class="icon-header-item cl2 hov-cl1 trans-04 p-l-22 p-r-11 js-show-modal-search">
                        <i class="zmdi zmdi-search"></i>
                    </div>
                    <div class="icon-header-item cl2 hov-cl1 trans-04 p-l-22 p-r-11 icon-header-noti js-show-cart"
                         data-notify="2">
                        <i class="zmdi zmdi-shopping-cart"></i>
                    </div>

                    <a class="icon-header-item cl2 hov-cl1 trans-04 p-l-22 p-r-11 icon-header-noti" data-notify="0"
                       href="#">
                        <i class="zmdi zmdi-favorite-outline"></i>
                    </a>

                    <div class="icon-header-item cl2 hov-cl1 trans-04 p-l-22 p-r-11 dropdown">
                        <i class="zmdi zmdi-account" data-toggle="dropdown" id="profileDropdown"></i>
                        <div aria-labelledby="profileDropdown" class="dropdown-menu">

                            <a class="dropdown-item" id="profileData" href="#"></a>
                            <a class="dropdown-item" href="#">My Profile</a>
                            <a class="dropdown-item" href="#">Order History</a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item" href="#">Logout</a>
                        </div>
                    </div>

                </div>
            </nav>
        </div>
    </div>
</header>

<div class="wrap-header-cart js-panel-cart">
    <div class="s-full js-hide-cart"></div>
    <div class="header-cart flex-col-l p-l-65 p-r-25">
        <div class="header-cart-title flex-w flex-sb-m p-b-8">
<span class="mtext-103 cl2">
Your Cart
</span>
            <div class="fs-35 lh-10 cl2 p-lr-5 pointer hov-cl1 trans-04 js-hide-cart">
                <i class="zmdi zmdi-close"></i>
            </div>
        </div>

        <div class="header-cart-content flex-w js-pscroll">
            <ul class="header-cart-wrapitem w-full" id="cartData">
                <!-- Danh sách sản phẩm trong giỏ hàng sẽ được thêm vào đây bằng JavaScript -->
            </ul>


        </div>


    </div>
</div>


<div class="bg0 m-t-23 p-b-140">
    <div class="container mt-5">
        <h1>Order History Customer</h1>
        <table class="table" id="orderData">


        </table>
        <button onclick="goBack()" class="btn btn-primary">Back</button>
    </div>
</div>
</div>
<footer class="bg3 p-t-75 p-b-32">
    <div class="container">
        <div class="row">
            <div class="col-sm-6 col-lg-3 p-b-50">
                <h4 class="stext-301 cl0 p-b-30">
                    Categories
                </h4>
                <ul>
                    <li class="p-b-10">
                        <a href="#" class="stext-107 cl7 hov-cl1 trans-04">
                            Women
                        </a>
                    </li>
                    <li class="p-b-10">
                        <a href="#" class="stext-107 cl7 hov-cl1 trans-04">
                            Men
                        </a>
                    </li>
                    <li class="p-b-10">
                        <a href="#" class="stext-107 cl7 hov-cl1 trans-04">
                            Shoes
                        </a>
                    </li>
                    <li class="p-b-10">
                        <a href="#" class="stext-107 cl7 hov-cl1 trans-04">
                            Watches
                        </a>
                    </li>
                </ul>
            </div>
            <div class="col-sm-6 col-lg-3 p-b-50">
                <h4 class="stext-301 cl0 p-b-30">
                    Help
                </h4>
                <ul>
                    <li class="p-b-10">
                        <a href="#" class="stext-107 cl7 hov-cl1 trans-04">
                            Track Order
                        </a>
                    </li>
                    <li class="p-b-10">
                        <a href="#" class="stext-107 cl7 hov-cl1 trans-04">
                            Returns
                        </a>
                    </li>
                    <li class="p-b-10">
                        <a href="#" class="stext-107 cl7 hov-cl1 trans-04">
                            Shipping
                        </a>
                    </li>
                    <li class="p-b-10">
                        <a href="#" class="stext-107 cl7 hov-cl1 trans-04">
                            FAQs
                        </a>
                    </li>
                </ul>
            </div>
            <div class="col-sm-6 col-lg-3 p-b-50">
                <h4 class="stext-301 cl0 p-b-30">
                    GET IN TOUCH
                </h4>
                <p class="stext-107 cl7 size-201">
                    Any questions? Let us know in store at 8th floor, 379 Hudson St, New York, NY 10018 or call us
                    on (+1) 96 716 6879
                </p>
                <div class="p-t-27">
                    <a href="#" class="fs-18 cl7 hov-cl1 trans-04 m-r-16">
                        <i class="fa fa-facebook"></i>
                    </a>
                    <a href="#" class="fs-18 cl7 hov-cl1 trans-04 m-r-16">
                        <i class="fa fa-instagram"></i>
                    </a>
                    <a href="#" class="fs-18 cl7 hov-cl1 trans-04 m-r-16">
                        <i class="fa fa-pinterest-p"></i>
                    </a>
                </div>
            </div>
            <div class="col-sm-6 col-lg-3 p-b-50">
                <h4 class="stext-301 cl0 p-b-30">
                    Newsletter
                </h4>
                <form>
                    <div class="wrap-input1 w-full p-b-4">
                        <input class="input1 bg-none plh1 stext-107 cl7" type="text" name="email"
                               placeholder="email@example.com">
                        <div class="focus-input1 trans-04"></div>
                    </div>
                    <div class="p-t-18">
                        <button class="flex-c-m stext-101 cl0 size-103 bg1 bor1 hov-btn2 p-lr-15 trans-04">
                            Subscribe
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <div class="p-t-40">
            <div class="flex-c-m flex-w p-b-18">
                <a href="#" class="m-all-1">
                    <img src="images/icons/icon-pay-01.png" alt="ICON-PAY">
                </a>
                <a href="#" class="m-all-1">
                    <img src="images/icons/icon-pay-02.png" alt="ICON-PAY">
                </a>
                <a href="#" class="m-all-1">
                    <img src="images/icons/icon-pay-03.png" alt="ICON-PAY">
                </a>
                <a href="#" class="m-all-1">
                    <img src="images/icons/icon-pay-04.png" alt="ICON-PAY">
                </a>
                <a href="#" class="m-all-1">
                    <img src="images/icons/icon-pay-05.png" alt="ICON-PAY">
                </a>
            </div>
            <p class="stext-107 cl6 txt-center">
                Copyright &copy;
                <script>document.write(new Date().getFullYear());</script> All rights reserved | This template is
                made with <i class="fa fa-heart-o" aria-hidden="true"></i> by <a href="https://colorlib.com/"
                                                                                 target="_blank">Colorlib</a>
            </p>
        </div>
    </div>
</footer>
<script>
function goBack() {
    window.history.back();
}

</script>
<script>
    // Hàm để gọi API và cập nhật dữ liệu đơn đặt hàng
    function loadOrderData() {
        // Lấy idUser từ tham số truyền vào URL
        const urlParams = new URLSearchParams(window.location.search);
        const idUser = urlParams.get('idUser');

        // Gọi API từ máy chủ
        fetch(`http://localhost:8080/order/${idUser}`)
            .then(response => response.json())
            .then(data => {
                // Xử lý dữ liệu và cập nhật vào trang HTML
                const orderDataElement = document.getElementById('orderData');
                orderDataElement.innerHTML = ''; // Xóa dữ liệu cũ trước khi thêm mới

                // Thêm header của bảng
                const headerRow = `
                    <tr>
                        <th>Customer</th>
                        <th>Name Product</th>
                        <th>Quantity</th>
                        <th>Price</th>
                        <th>Status</th>
                        <th>Time</th>
                        <th>Action</th>
                    </tr>`;
                orderDataElement.innerHTML += headerRow;

                // Duyệt qua danh sách đơn đặt hàng và thêm vào trang HTML
                data.data.forEach(order => {
                    const row = `
                        <tr>
                            <td>${order.nameUser}</td>
                            <td>${order.nameProduct}</td>
                            <td>${order.quantity}</td>
                            <td>${order.price}</td>
                            <td>${order.nameStatus}</td>
                            <td>${order.createDate}</td>
                            <td>
                                <button onclick="updateOrderStatus(${order.idOrder}, 1)" class="btn btn-success" ${order.statusUpdated ? 'disabled' : ''}>Successfully</button>
                                <button onclick="updateOrderStatus(${order.idOrder}, 2)" class="btn btn-danger" ${order.statusUpdated ? 'disabled' : ''}>Order Cancellation</button>
                            </td>
                        </tr>`;
                    orderDataElement.innerHTML += row;
                });
            })
            .catch(error => {
                console.error('Error fetching order data:', error);
            });
    }

    // Hàm để cập nhật trạng thái đơn hàng
    // Hàm để cập nhật trạng thái đơn hàng
function updateOrderStatus(orderId, statusId) {
    // Check if the order status has already been updated
    const statusCell = document.querySelector(`#orderData td[data-order-id="${orderId}"][data-column="Status"]`);

    // Log the selector and statusCell to help identify the issue
    console.log(`#orderData td[data-order-id="${orderId}"][data-column="Status"]`, statusCell);

    const isStatusUpdated = statusCell && statusCell.innerText !== 'Pending'; // Update this condition based on your logic

    if (isStatusUpdated) {
        // If status is already updated, do nothing
        return;
    }

    fetch(`http://localhost:8080/order/${orderId}?idStatus=${statusId}`, { method: 'PUT' })
        .then(response => response.json())
        .then(data => {
            // Kiểm tra nếu cập nhật thành công
            if (data.statusCode === 200) {
                // Cập nhật giao diện trạng thái đơn hàng
                statusCell.innerText = (statusId === 1) ? "Successfully" : "Order Cancellation";

                // Mark the order as updated
                const orderButton = document.querySelector(`#orderData button[data-order-id="${orderId}"]`);
                orderButton.setAttribute('disabled', true);
            } else {
                console.error('Error updating order:', data.message);
            }
        })
        .catch(error => {
            console.error('Error updating order:', error);
        });
}


    // Gọi hàm để tải dữ liệu khi trang được load
    window.onload = loadOrderData;
</script>


<script>
        $(document).ready(function() {
            // Lấy token từ Local Storage
            var token = localStorage.getItem("token");
            // Kiểm tra xem token có tồn tại không
            if (token) {
                // Gửi token đến endpoint /user/decode-token để giải mã
                $.ajax({
                    url: "http://localhost:8080/user/decode-token",
                    method: "post",
                    data: {
                        token: token
                    }
                }).done(function(data) {
                    // Kiểm tra dữ liệu trả về
                    if (data && data.userId) {
                        // Hiển thị id người dùng
                        $("#profileData").html("User ID: " + data.userId);
                    } else {
                        $("#profileData").html("Failed to get user ID");
                    }
                }).fail(function() {
                    $("#profileData").html("Failed to decode token");
                });
            } else {
                $("#profileData").html("Token not found in Local Storage");
            }
        });
    </script>


<script>
        $(document).ready(function() {
            // Lấy token từ Local Storage
            var token = localStorage.getItem("token");

            // Kiểm tra xem token có tồn tại không
            if (token) {
                // Gửi token đến endpoint /user/decode-token để giải mã
                $.ajax({
                    url: "http://localhost:8080/user/decode-token",
                    method: "post",
                    data: {
                        token: token
                    }
                }).done(function(data) {
                    // Kiểm tra dữ liệu trả về
                    if (data && data.userId) {
                        // Gửi request để lấy giỏ hàng của người dùng
                        $.ajax({
                            url: "http://localhost:8080/cart/" + data.userId,
                            method: "get"
                        }).done(function(cartData) {
                            // Kiểm tra dữ liệu giỏ hàng trả về
                            if (cartData && cartData.data) {
                                // Hiển thị thông tin giỏ hàng
                                displayCart(cartData.data);
                            } else {
                                $("#cartData").html("Failed to get cart data");
                            }
                        }).fail(function() {
                            $("#cartData").html("Failed to get cart data");
                        });
                    } else {
                        $("#cartData").html("Failed to get user ID");
                    }
                }).fail(function() {
                    $("#cartData").html("Failed to decode token");
                });
            } else {
                $("#cartData").html("Token not found in Local Storage");
            }
            // Hàm hiển thị thông tin giỏ hàng
        function displayCart(cartData) {
            var cartHtml = "<div class='header-cart-content flex-w js-pscroll'>";
            cartHtml += "<ul class='header-cart-wrapitem w-full'>";
            // Lặp qua danh sách sản phẩm trong giỏ hàng
            for (var i = 0; i < cartData.length; i++) {
                var product = cartData[i];
                cartHtml += "<li class='header-cart-item flex-w flex-t m-b-12'>";
                cartHtml += "<div class='header-cart-item-img'>";
                cartHtml += "<img alt='IMG' src='images/" + product.imageProduct + "'>";
                cartHtml += "</div>";
                cartHtml += "<div class='header-cart-item-txt p-t-8'>";
                cartHtml += "<a class='header-cart-item-name m-b-18 hov-cl1 trans-04' href='#'>";
                cartHtml += product.nameProduct;
                cartHtml += "</a>";
                cartHtml += "<span class='header-cart-item-info'>" + product.quanity + " x $" + product.price + "</span>";

                // Thêm button xóa với sự kiện onclick để gọi hàm xóa
                cartHtml += "<button class='btn-delete' data-id='" + product.cart + "'>Delete</button>";

                cartHtml += "</div>";
                cartHtml += "</li>";
            }
            cartHtml += "</ul>";
            cartHtml += "<div class='w-full'>";
            cartHtml += "<div class='header-cart-total w-full p-tb-40'>";
            // Tính tổng giá trị giỏ hàng
            var total = 0;
            for (var i = 0; i < cartData.length; i++) {
                total += cartData[i].quanity * cartData[i].price;
            }
            cartHtml += "Total: $" + total.toFixed(2);
            cartHtml += "</div>";
            cartHtml += "<div class='header-cart-buttons flex-w w-full'>";
            cartHtml += "<a class='flex-c-m stext-101 cl0 size-107 bg3 bor2 hov-btn3 p-lr-15 trans-04 m-r-8 m-b-10' href='cart.html'>";
            cartHtml += "View Cart";
            cartHtml += "</a>";
            cartHtml += "<a class='flex-c-m stext-101 cl0 size-107 bg3 bor2 hov-btn3 p-lr-15 trans-04 m-b-10' href='cart.html'>";
            cartHtml += "Check Out";
            cartHtml += "</a>";
            cartHtml += "</div>";
            cartHtml += "</div>";
            cartHtml += "</div>";

            // Hiển thị HTML của giỏ hàng
            $("#cartData").html(cartHtml);

            // Gắn sự kiện cho button xóa
            $(".btn-delete").on("click", function() {
                var cartId = $(this).data("id");
                // Gửi request để xóa sản phẩm từ giỏ hàng
                $.ajax({
                    url: "http://localhost:8080/cart/" + cartId,
                    method: "delete"
                }).done(function(response) {
                    if (response && response.statusCode === 200) {
                        // Nếu xóa thành công, cập nhật lại giỏ hàng
                        displayCart(cartData.filter(function(product) {
                            return product.cart !== cartId;
                        }));
                    } else {
                        alert("Failed to delete item from cart");
                    }
                }).fail(function() {
                    alert("Failed to delete item from cart");
                });
            });
        }
    });
</script>




<script async src="https://www.googletagmanager.com/gtag/js?id=UA-23581568-13"></script>
<script src="vendor/jquery/jquery-3.2.1.min.js"></script>
<script src="vendor/animsition/js/animsition.min.js"></script>
<script src="vendor/bootstrap/js/popper.js"></script>
<script src="vendor/bootstrap/js/bootstrap.min.js"></script>
<script src="vendor/select2/select2.min.js"></script>
<script src="vendor/slick/slick.min.js"></script>
<script src="js/slick-custom.js"></script>
<script src="js/main.js"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-23581568-13"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-23581568-13"></script>
<script src="vendor/jquery/jquery-3.2.1.min.js"></script>
<script src="vendor/animsition/js/animsition.min.js"></script>
<script src="vendor/bootstrap/js/popper.js"></script>
<script src="vendor/bootstrap/js/bootstrap.min.js"></script>
<script src="vendor/select2/select2.min.js"></script>
<script src="vendor/slick/slick.min.js"></script>
<script src="js/slick-custom.js"></script>
<script src="js/main.js"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-23581568-13"></script>
</body>
</html>